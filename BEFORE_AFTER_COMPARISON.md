# å‰åç«¯é›†æˆå¯¹æ¯”è¯´æ˜

## ğŸ”„ ä¿®æ”¹å‰åå¯¹æ¯”

### ä¿®æ”¹å‰ï¼ˆâŒ å‰ç«¯æœ¬åœ°æ¨¡æ‹Ÿï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        å‰ç«¯ - LoginView.vue         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  onLogin()                          â”‚
â”‚    â†“                                â”‚
â”‚  readUsers() ä» localStorage è¯»ç”¨æˆ· â”‚
â”‚    â†“                                â”‚
â”‚  æœ¬åœ°å¯¹æ¯”å¯†ç                        â”‚
â”‚    â†“                                â”‚
â”‚  ç”Ÿæˆæœ¬åœ° Token                     â”‚
â”‚    â†“                                â”‚
â”‚  ä¿å­˜åˆ° localStorage                â”‚
â”‚    â†“                                â”‚
â”‚  ç™»å½•æˆåŠŸ âœ…                        â”‚
â”‚                                     â”‚
â”‚  âŒ æ•°æ®åªå­˜åœ¨æœ¬åœ°ï¼Œä¸æ˜¯çœŸå®ç”¨æˆ·     â”‚
â”‚  âŒ æ²¡æœ‰æ•°æ®åº“æ”¯æŒ                  â”‚
â”‚  âŒ æ— æ³•çœŸå®éªŒè¯èº«ä»½                â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¿®æ”¹åï¼ˆâœ… è°ƒç”¨åç«¯ APIï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯ Login Page    â”‚                â”‚    åç«¯ Auth Routes          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                      â”‚                â”‚                              â”‚
â”‚ onLogin()            â”‚ POST           â”‚ router.post('/login', ...)   â”‚
â”‚   â†“                  â”‚ {account,      â”‚   â†“                          â”‚
â”‚ authApi.login()      â”‚  password}     â”‚ æŸ¥è¯¢æ•°æ®åº“                   â”‚
â”‚   â†“                  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  â”‚   â†“                          â”‚
â”‚ Fetch API            â”‚                â”‚ éªŒè¯å¯†ç                      â”‚
â”‚   â†“                  â”‚                â”‚   â†“                          â”‚
â”‚ å‘é€è¯·æ±‚             â”‚                â”‚ ç”Ÿæˆ JWT Token               â”‚
â”‚                      â”‚                â”‚   â†“                          â”‚
â”‚ â†“â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚ {token,        â”‚ è¿”å› Token + ç”¨æˆ·ä¿¡æ¯        â”‚
â”‚ æ¥æ”¶å“åº”             â”‚  userId,       â”‚                              â”‚
â”‚   â†“                  â”‚  username}     â”‚                              â”‚
â”‚ ä¿å­˜ Token           â”‚                â”‚ æ•°æ®åº“                       â”‚
â”‚ ä¿å­˜ç”¨æˆ·ä¿¡æ¯         â”‚                â”‚ â†‘                            â”‚
â”‚   â†“                  â”‚                â”‚ [users è¡¨]                   â”‚
â”‚ ç™»å½•æˆåŠŸ âœ…          â”‚                â”‚ id | username | password_hashâ”‚
â”‚                      â”‚                â”‚                              â”‚
â”‚ âœ… çœŸå®èº«ä»½éªŒè¯      â”‚                â”‚                              â”‚
â”‚ âœ… æ•°æ®åº“æ”¯æŒ        â”‚                â”‚                              â”‚
â”‚ âœ… å®Œæ•´çš„åç«¯é€»è¾‘    â”‚                â”‚                              â”‚
â”‚                      â”‚                â”‚                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ ä»£ç å¯¹æ¯”

### ç™»å½•å‡½æ•°å¯¹æ¯”

#### âŒ ä¿®æ”¹å‰
```typescript
async function onLogin() {
  const a = account.value.trim()
  const p = password.value
  
  if (!a) return alert('è¯·è¾“å…¥ç”¨æˆ·åæˆ–é‚®ç®±')
  if (!p) return alert('è¯·è¾“å…¥å¯†ç ')

  loading.value = true
  try {
    // âŒ ä»æœ¬åœ°å­˜å‚¨è¯»å–ç”¨æˆ·åˆ—è¡¨
    const users = readUsers()
    
    // âŒ åœ¨æœ¬åœ°æŸ¥æ‰¾ç”¨æˆ·
    const u = findUserByAccount(users, a)
    if (!u) return alert('è´¦å·ä¸å­˜åœ¨ï¼Œè¯·å…ˆæ³¨å†Œ')

    // âŒ æœ¬åœ°è®¡ç®—å¯†ç å“ˆå¸Œï¼Œå¯¹æ¯”
    const ph = await sha256Base64(p)
    if (ph !== u.passwordHash) return alert('å¯†ç é”™è¯¯')

    // âŒ ç”Ÿæˆæœ¬åœ° Token
    const token = (crypto as any).randomUUID ? (crypto as any).randomUUID() : String(Date.now())
    localStorage.setItem('token', token)
    localStorage.setItem('isLoggedIn', '1')
    localStorage.setItem('auth_current_user', JSON.stringify({ username: u.username, email: u.email }))

    alert('ç™»å½•æˆåŠŸ')
    router.replace(redirectTo.value)
  } finally {
    loading.value = false
  }
}
```

#### âœ… ä¿®æ”¹å
```typescript
async function onLogin() {
  const a = account.value.trim()
  const p = password.value

  if (!a) return alert('è¯·è¾“å…¥ç”¨æˆ·åæˆ–é‚®ç®±')
  if (!p) return alert('è¯·è¾“å…¥å¯†ç ')

  loading.value = true
  try {
    // âœ… è°ƒç”¨åç«¯ API
    const res = await authApi.login(a, p, false)
    
    // âœ… æ£€æŸ¥åç«¯å“åº”
    if (!res.success) {
      return alert(res.message || 'ç™»å½•å¤±è´¥')
    }

    const userData = res.data as any
    
    // âœ… ä¿å­˜åç«¯è¿”å›çš„çœŸå® Token
    localStorage.setItem('token', userData.token)
    localStorage.setItem('isLoggedIn', '1')
    localStorage.setItem('auth_current_user', JSON.stringify({ 
      username: userData.username, 
      email: userData.email,
      userId: userData.userId
    }))
    localStorage.setItem('userName', userData.username)
    localStorage.setItem('userEmail', userData.email)
    localStorage.setItem('userId', userData.userId)

    // âœ… ä¿å­˜è®°ä½æˆ‘ Tokenï¼ˆå¦‚æœæœ‰ï¼‰
    if (userData.rememberToken) {
      localStorage.setItem('rememberToken', userData.rememberToken)
    }

    window.dispatchEvent(new Event('auth-changed'))
    alert('ç™»å½•æˆåŠŸ')
    router.replace(redirectTo.value)
  } catch (error) {
    console.error('ç™»å½•é”™è¯¯ï¼š', error)
    alert('ç™»å½•è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥')
  } finally {
    loading.value = false
  }
}
```

---

## ğŸ“Š åŠŸèƒ½å¯¹æ¯”è¡¨

| åŠŸèƒ½ | ä¿®æ”¹å‰ | ä¿®æ”¹å |
|------|--------|--------|
| **ç”¨æˆ·æ•°æ®å­˜å‚¨** | æœ¬åœ° localStorage | æ•°æ®åº“ï¼ˆPostgreSQLï¼‰ |
| **å¯†ç éªŒè¯** | æœ¬åœ°å¯¹æ¯”å“ˆå¸Œ | åç«¯éªŒè¯ |
| **éªŒè¯ç ** | æœ¬åœ°ç”Ÿæˆ | åç«¯å‘é‚®ä»¶ |
| **è®¤è¯æ–¹å¼** | æœ¬åœ°ç”Ÿæˆçš„ Token | JWT Token |
| **ç”¨æˆ·éš”ç¦»** | âŒ åŒä¸€æµè§ˆå™¨æ‰€æœ‰ç”¨æˆ·ç›¸åŒ | âœ… çœŸå®ç”¨æˆ·éš”ç¦» |
| **å¤šè®¾å¤‡ç™»å½•** | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒï¼ˆä½¿ç”¨ Tokenï¼‰ |
| **è®°ä½æˆ‘åŠŸèƒ½** | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒ |
| **é‚®ä»¶éªŒè¯** | âŒ æœ¬åœ°æç¤º | âœ… çœŸå®é‚®ä»¶ |
| **å®‰å…¨æ€§** | âŒ ä½ï¼ˆæ˜æ–‡å­˜å‚¨ï¼‰ | âœ… é«˜ï¼ˆåŠ å¯†å¯†ç ï¼ŒJWTï¼‰ |
| **å¯æ‰©å±•æ€§** | âŒ ä½ | âœ… é«˜ï¼ˆå®Œæ•´åç«¯ï¼‰ |

---

## ğŸ” å®‰å…¨æ€§æ”¹è¿›

### ä¿®æ”¹å‰çš„é—®é¢˜
```
âŒ å¯†ç ä»¥å“ˆå¸Œå½¢å¼å­˜å‚¨åœ¨æœ¬åœ°ï¼Œç”¨æˆ·å¯çœ‹åˆ°
âŒ Token æ˜¯éšæœºå­—ç¬¦ä¸²ï¼Œæ²¡æœ‰åŠ å¯†éªŒè¯
âŒ ä»»ä½•äººçŸ¥é“é‚®ç®±å°±èƒ½æ³¨å†Œï¼Œæ²¡æœ‰éªŒè¯ç é™åˆ¶
âŒ æ²¡æœ‰çœŸå®çš„èº«ä»½éªŒè¯æœºåˆ¶
âŒ æ‰€æœ‰ç”¨æˆ·æ•°æ®æ··åœ¨ä¸€èµ·ï¼Œæ— æ³•éš”ç¦»
```

### ä¿®æ”¹åçš„æ”¹è¿›
```
âœ… å¯†ç åœ¨åç«¯åŠ å¯†å­˜å‚¨ï¼Œå‰ç«¯çœ‹ä¸åˆ°
âœ… Token æ˜¯ JWTï¼ŒåŒ…å«ç­¾åéªŒè¯
âœ… æ³¨å†Œéœ€è¦é‚®ç®±éªŒè¯ç ï¼Œé˜²æ­¢æ¶æ„æ³¨å†Œ
âœ… åç«¯å®Œæ•´çš„èº«ä»½éªŒè¯æµç¨‹
âœ… æ¯ä¸ªç”¨æˆ·æœ‰ç‹¬ç«‹çš„æ•°æ®åº“è®°å½•
âœ… æ•°æ®åº“å¯†ç ä½¿ç”¨ bcrypt åŠ å¯†
âœ… Token æœ‰è¿‡æœŸæ—¶é—´ä¿æŠ¤
```

---

## ğŸ“¡ API è°ƒç”¨ç¤ºä¾‹

### æ³¨å†Œæµç¨‹

```typescript
// 1. å‘é€éªŒè¯ç 
const res1 = await authApi.sendCode('user@example.com', 'register')
// å“åº”ï¼š{ success: true, message: 'éªŒè¯ç å·²å‘é€' }
// ç”¨æˆ·åœ¨é‚®ç®±ä¸­æ”¶åˆ°éªŒè¯ç 

// 2. æäº¤æ³¨å†Œ
const res2 = await authApi.register(
  'testuser',                 // username
  'user@example.com',         // email
  'Password@123',             // password
  'Password@123',             // confirmPassword
  '123456'                    // codeï¼ˆä»é‚®ä»¶è·å¾—ï¼‰
)
// å“åº”ï¼š
// {
//   success: true,
//   data: {
//     userId: 1,
//     username: 'testuser',
//     email: 'user@example.com',
//     token: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'
//   }
// }
```

### ç™»å½•æµç¨‹

```typescript
// 1. ç™»å½•
const res = await authApi.login(
  'user@example.com',     // accountï¼ˆç”¨æˆ·åæˆ–é‚®ç®±ï¼‰
  'Password@123',         // password
  true                    // rememberMeï¼ˆå¯é€‰ï¼‰
)
// å“åº”ï¼š
// {
//   success: true,
//   data: {
//     userId: 1,
//     username: 'testuser',
//     email: 'user@example.com',
//     token: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...',
//     rememberToken: 'long-lived-token-string'  // å¯é€‰
//   }
// }

// 2. åç»­è¯·æ±‚ä½¿ç”¨ Token
fetch('/api/user/profile', {
  headers: {
    'Authorization': `Bearer ${localStorage.getItem('token')}`
  }
})
```

---

## ğŸ¯ æ¶æ„å¯¹æ¯”

### ä¿®æ”¹å‰æ¶æ„ï¼ˆå•å±‚ - å‰ç«¯ï¼‰
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æµè§ˆå™¨        â”‚
â”‚  + Frontend     â”‚
â”‚  + Data Store   â”‚  â† æ‰€æœ‰é€»è¾‘å’Œæ•°æ®éƒ½åœ¨å‰ç«¯
â”‚  + Validation   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
    localStorage
```

### ä¿®æ”¹åæ¶æ„ï¼ˆä¸‰å±‚ - å‰åç«¯åˆ†ç¦»ï¼‰
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯             â”‚
â”‚  LoginView.vue     â”‚
â”‚  (UI + Logic)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ HTTP API
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åç«¯             â”‚
â”‚  auth.js           â”‚ â† æ ¸å¿ƒé€»è¾‘
â”‚  + éªŒè¯             â”‚
â”‚  + åŠ å¯†             â”‚
â”‚  + Token ç”Ÿæˆ      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ SQL
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ•°æ®åº“           â”‚
â”‚  PostgreSQL        â”‚
â”‚  + users          â”‚
â”‚  + verification_  â”‚
â”‚    codes          â”‚
â”‚  + remember_      â”‚
â”‚    tokens         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… ä¸‹ä¸€æ­¥ä»»åŠ¡

ç°åœ¨é›†æˆå·²å®Œæˆï¼Œä½ å¯ä»¥ï¼š

1. **æµ‹è¯•ç™»å½•æ³¨å†Œ**
   - å¯åŠ¨åç«¯å’Œå‰ç«¯
   - å°è¯•æ³¨å†Œæ–°è´¦å·
   - å°è¯•ç™»å½•

2. **é›†æˆå…¶ä»–é¡µé¢**
   - åœ¨å…¶ä»–é¡µé¢ä¸­ä½¿ç”¨ `localStorage.getItem('token')`
   - åœ¨éœ€è¦è®¤è¯çš„ API è°ƒç”¨ä¸­æ·»åŠ  Token å¤´

3. **å®ç°è‡ªåŠ¨ç™»å½•**
   - ä½¿ç”¨ `rememberToken` å®ç°"è®°ä½æˆ‘"åŠŸèƒ½
   - é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥ Token æœ‰æ•ˆæ€§

4. **å®Œå–„é”™è¯¯å¤„ç†**
   - å¤„ç† Token è¿‡æœŸæƒ…å†µ
   - å¤„ç†ç½‘ç»œé”™è¯¯
   - ä¼˜åŒ–ç”¨æˆ·æç¤ºä¿¡æ¯

---

**å®Œæˆæ—¥æœŸ**ï¼š2025-12-26
**é›†æˆçŠ¶æ€**ï¼šâœ… å®Œæˆå¹¶æ–‡æ¡£åŒ–
