# 🗺️ 长三角非遗地图 - 热力图功能使用指南

## 📋 快速开始

### 1️⃣ 安装依赖

```bash
cd hesitage/front
npm install mapbox-gl
npm install
```

### 2️⃣ 启动服务

**方式一：使用批处理脚本**
```bash
# 在项目根目录执行
start-services.bat
```

**方式二：手动启动**

```bash
# 终端1 - 启动后端服务
cd hesitage/backend
npm install
npm start
# 后端运行在 http://localhost:3000

# 终端2 - 启动前端开发服务器
cd hesitage/front
npm install
npm run dev
# 前端运行在 http://localhost:5173
```

### 3️⃣ 打开应用

在浏览器中访问：`http://localhost:5173`

---

## 🎯 功能说明

### 🔥 热力图功能

长三角地区的每个城市用一个圆形表示，根据该城市的非遗项目数量：

| 颜色 | 含义 | 项目数 |
|------|------|--------|
| 🔴 深红色 | 非遗最多 | 40+ |
| 🟠 橙色 | 非遗较多 | 20-39 |
| 🟡 金黄色 | 非遗中等 | 10-19 |
| 🟨 浅黄色 | 非遗较少 | 5-9 |
| ⚪ 淡黄色 | 非遗很少 | <5 |

**圆形大小**也随非遗数量增加而变大，便于直观对比。

### 🏘️ 省份选择

左侧工具栏列出了4个省份：

- **浙江省** - 232个非遗项目（最多）
- **江苏省** - 132个非遗项目
- **上海市** - 65个非遗项目
- **安徽省** - 84个非遗项目

点击任意省份按钮，地图会自动：
1. ✈️ 飞向该省份中心
2. 🔍 调整缩放级别使整个省份完整显示
3. 💡 左侧统计面板更新显示该省份的详细数据

### 💬 悬停提示

将鼠标移到任意城市圆形上，右侧会弹出信息面板显示：

- **城市名称**
- **省份**
- **非遗项目总数**
- **涵盖的分类数**
- **主要分类**（前3个）

### 🔧 地图工具

**左侧工具栏的按钮：**

| 按钮 | 功能 |
|------|------|
| 🔥 热力图 | 切换热力图显示/隐藏 |
| ↺ 重置视图 | 恢复为全国视图 |

### 📊 统计信息

实时显示：
- **总非遗项目数** - 全部项目总计
- **省份数** - 覆盖的省份个数（4个）
- **城市数** - 覆盖的城市个数（总共54个城市）

---

## 🎮 交互操作

### 地图操作

| 操作 | 效果 |
|------|------|
| **鼠标滚轮** | 缩放地图 |
| **鼠标拖拽** | 平移地图 |
| **右键拖拽** | 旋转地图（如果支持） |
| **悬停城市** | 显示该城市的统计信息 |

### 按钮操作

| 操作 | 效果 |
|------|------|
| **点击省份按钮** | 地图缩放到该省份，完整显示整个省份 |
| **点击热力图按钮** | 开启/关闭热力图显示 |
| **点击重置按钮** | 恢复默认视图（全国地图） |

---

## 📈 数据更新

### 热力图数据刷新

刷新浏览器页面或重新访问 `/map` 路由会重新加载最新数据：

1. 前端从后端 API 获取热力图数据
2. 从后端 API 获取省份边界数据
3. 自动绘制热力图并更新统计信息

### 查看表的所有字段

如果需要查看数据库表的字段信息，运行诊断脚本：

```bash
cd hesitage/backend
node scripts/getTableInfo.js
```

这会输出：
- 表的所有字段列表
- 数据统计（总项目数、城市数、省份数）
- 各城市的非遗项目排名（Top 20）
- 各省份的详细统计信息
- 各分类的统计数据
- 数据质量检查

---

## 🔗 API 接口

### 获取热力图数据

```
GET http://localhost:3000/api/spatial/heatmap-data
```

**响应格式：**
```json
{
  "success": true,
  "data": [
    {
      "city_name": "杭州市",
      "province": "浙江省",
      "heritage_count": 44,
      "category_count": 12,
      "center_lng": "120.15",
      "center_lat": "30.28",
      "categories": "传统戏剧|传统美术|..."
    }
  ]
}
```

### 获取省份边界数据

```
GET http://localhost:3000/api/spatial/province-bounds
```

**响应格式：**
```json
{
  "success": true,
  "data": [
    {
      "province": "浙江省",
      "heritage_count": 232,
      "city_count": 11,
      "bounds": [[118.41, 27.52], [122.45, 31.03]],
      "center": [120.388, 29.400],
      "zoom": 7
    }
  ]
}
```

---

## ⚠️ 常见问题

### Q1: 热力图不显示怎么办？

**检查步骤：**

1. 打开浏览器开发者工具（F12）
2. 查看 Console 选项卡是否有错误
3. 查看 Network 选项卡确认 API 请求：
   - `/api/spatial/heatmap-data` - 应返回 200 状态
   - `/api/spatial/province-bounds` - 应返回 200 状态

4. **检查后端是否运行：**
   ```bash
   curl http://localhost:3000/api/spatial/heatmap-data
   ```

5. **检查前端连接地址：** 
   - 确保前端代码中的 `http://localhost:3000` 与实际后端地址一致

### Q2: 点击省份按钮但地图没有缩放怎么办？

**可能原因：**
- ECharts 地图库加载失败
- 省份坐标数据错误

**解决方案：**
1. 刷新页面重新加载
2. 查看浏览器 console 错误信息
3. 检查数据是否正确返回

### Q3: 信息面板显示不了怎么办？

**检查：**
- 确保已使用最新版本的 `MapView.vue`
- 清除浏览器缓存：`Ctrl + Shift + Delete`
- 重新启动前端服务

### Q4: 如何修改热力图的颜色？

在 `hesitage/front/src/views/MapView.vue` 中找到 `initChart()` 函数，修改以下代码：

```javascript
color: function (params: any) {
  const value = params.data[2]
  if (value >= 40) return '#bd0026'  // 修改颜色代码
  // ... 其他颜色
}
```

---

## 🚀 高级功能扩展

### 1. 添加时间维度选择

实现年份或时间段选择，查看不同时期的非遗分布变化。

### 2. 按分类过滤

添加非遗分类复选框，只显示特定分类的非遗项目热力图。

### 3. 详情弹窗

点击城市圆形时弹出该城市所有非遗项目的详细列表。

### 4. 数据导出

支持导出当前视图的统计数据为 Excel 或 PDF 格式。

### 5. 比较分析

选择多个城市进行对比分析，显示非遗分布的差异。

---

## 📚 参考资源

- [ECharts 官方文档](https://echarts.apache.org/)
- [Vue 3 官方文档](https://v3.vuejs.org/)
- [PostgreSQL 空间查询](https://www.postgresql.org/docs/current/)
- [GeoJSON 规范](https://geojson.org/)

---

## 💡 提示

- 🖱️ 使用鼠标滚轮在不同缩放级别间快速浏览
- 📍 点击省份后可继续缩放查看具体城市细节
- 🔄 热力图数据实时更新，数据库变化后无需重启即可看到新数据
- 🎨 根据非遗项目数量的颜色变化可快速识别非遗集中地区

---

**最后更新：** 2024年

**维护者：** 地理信息服务课程小组
